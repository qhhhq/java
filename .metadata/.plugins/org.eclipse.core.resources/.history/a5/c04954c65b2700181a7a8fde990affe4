package net.qhhhq.service.file;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.FileWriter;
import java.io.InputStream;
import java.io.PrintWriter;
import java.util.Map;

import org.apache.log4j.Logger;
import org.json.JSONObject;

import net.qhhhq.global.service.Service;
import net.qhhhq.service.common.AppHead;
import net.qhhhq.service.common.HandlerChain;
import net.qhhhq.service.common.SysHead;

public class FileServiceBean implements Service {

	private static Logger log = Logger.getLogger(FileServiceBean.class);

	public void execute(Map<String, Object> paramMap, HandlerChain paramHandlerChain, SysHead sysHead, AppHead appHead,
			JSONObject data) {
		if (sysHead.getFileType() == null || sysHead.getFileType().trim().equals("")) {
			sysHead.setFail("000011", "sysHead.FILE_TYPE 文件所属类别不能为空");
		} else {
			String file = (String) paramMap.get("file");
			String filePath = (String) paramMap.get("filePath");
			if (filePath == null) {
				sysHead.setFail("999999", "系统错误，上传失败");
				log.error("文件上传路径为空，系统错误");
				return;
			}
			if (file != null) {
				String suffix = file.substring(file.lastIndexOf("."));
				StringBuffer fileName = new StringBuffer();
				fileName.append(sysHead.getFileType()).append("/");
				fileName.append(sysHead.getTranDate().replaceAll("-", ""));
				log.info(filePath + fileName);
				File dirFile = new File(filePath + fileName);
				if (!dirFile.exists()) {
					dirFile.mkdir();
				}
				fileName.append("/");
				fileName.append(sysHead.getSeqNo());
				fileName.append(suffix);
				newFile(filePath + fileName);
				copyFile(file, filePath + fileName);
			} else {
				sysHead.setFail("000012", "上传文件为空，上传失败");
			}
		}
	}

	/**
	 * 新建文件
	 *
	 * @param filePathAndName
	 *            String 文件路径及名称 如c:/fqf.txt
	 * @param fileContent
	 *            String 文件内容
	 * @return boolean
	 */
	private void newFile(String filePathAndName) {
		try {
			String filePath = filePathAndName;
			filePath = filePath.toString(); // 取的路径及文件名
			File myFilePath = new File(filePath);
			/** 如果文件不存在就建一个新文件 */
			if (!myFilePath.exists()) {
				myFilePath.createNewFile();
			}
			FileWriter resultFile = new FileWriter(myFilePath); // 用来写入字符文件的便捷类,
			resultFile.close();

		} catch (Exception e) {
			System.out.println("新建文件操作出错");
			e.printStackTrace();

		}
	}

	/**
	 * 复制单个文件
	 *
	 * @param oldPath
	 *            String 原文件路径 如：c:/fqf.txt
	 * @param newPath
	 *            String 复制后路径 如：f:/fqf.txt
	 * @return boolean
	 */
	private void copyFile(String oldPath, String newPath) {
		try {
			int byteread = 0;
			File oldfile = new File(oldPath);
			if (oldfile.exists()) { // 文件存在时
				InputStream inStream = new FileInputStream(oldPath); // 读入原文件
				FileOutputStream fs = new FileOutputStream(newPath);
				byte[] buffer = new byte[1444];
				while ((byteread = inStream.read(buffer)) != -1) {
					fs.write(buffer, 0, byteread);
				}
				inStream.close();
			}
		} catch (Exception e) {
			System.out.println("复制单个文件操作出错");
			e.printStackTrace();

		}

	}
}
