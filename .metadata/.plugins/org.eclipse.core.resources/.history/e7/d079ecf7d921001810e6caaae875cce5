package net.qhhhq.service.user;

import java.io.IOException;
import java.net.URISyntaxException;
import java.util.HashMap;
import java.util.Map;

import org.apache.log4j.Logger;
import org.json.JSONException;
import org.json.JSONObject;
import org.springframework.stereotype.Component;

import com.alibaba.dubbo.config.annotation.Reference;

import net.qhhhq.api.user.UserService;
import net.qhhhq.base.QueryResult;
import net.qhhhq.global.service.Service;
import net.qhhhq.http.HttpClient;
import net.qhhhq.http.JsonResponseHandler;
import net.qhhhq.model.user.UserInfo;
import net.qhhhq.service.common.AppHead;
import net.qhhhq.service.common.HandlerChain;
import net.qhhhq.service.common.SysHead;
import net.qhhhq.utils.Utils;

@Component
public class UserServiceBean implements Service {

	private static Logger log = Logger.getLogger(UserServiceBean.class);
	@Reference
	static UserService userService;

	public void handle(Map<String, Object> paramMap, HandlerChain paramHandlerChain, SysHead sysHead, AppHead appHead,
			JSONObject data) {
		log.info("UserServiceBean start ......");
		if(Utils.theService(sysHead, "hhq12000001")) {
			JSONObject userInfo = new JSONObject(paramMap.get("DATA").toString());
			if(userInfo != null) {
				JSONObject user = userInfo.getJSONObject("userInfo");
				if(user != null) {
					try {
						save(user);
					} catch (Exception e) {
						sysHead.setFail("000100", "用户保存失败");
						e.printStackTrace();
					}
				} else {
					sysHead.setFail("000050", "请求数据不完整");
				}
			}
		} else if(Utils.theService(sysHead, "hhq14000001")) {
			QueryResult<UserInfo> result = userService.getScrollData();
			data.put("result", new JSONObject(result));
		}
	}

	private void save(JSONObject userInfo) throws JSONException, URISyntaxException, IOException {
		UserInfo user = new UserInfo();
		JSONObject open = getOpenId(userInfo.getString("code"));
		String openId = open.getString("openid");
		if(!userService.hasOpenId(openId)) {
			user.setOpenid(openId);
			if(open.has("unionid"))
				user.setUnionid(open.getString("unionid"));
			user.setAvatarurl(userInfo.getString("avatarUrl"));
			user.setCity(userInfo.getString("city"));
			user.setCountry(userInfo.getString("country"));
			user.setGender(String.valueOf(userInfo.getInt("gender")));
			user.setLanguage(userInfo.getString("language"));
			user.setNickname(userInfo.getString("nickName"));
			user.setProvince(userInfo.getString("province"));
			userService.save(user);
		} else {
			log.debug("该用户信息已经存在");
		}
	}

	private JSONObject getOpenId(String code) throws URISyntaxException, IOException {
		Map<String, String> params = new HashMap<String, String>();
		params.put("appid", "wx275a30f644ebc4c9");
		params.put("secret", "ae0c581b7a6bf0792c87d00a1a8a1d9b");
		params.put("js_code", code);
		params.put("grant_type", "authorization_code");
		JsonResponseHandler handler = new JsonResponseHandler();
		Object obj = HttpClient.doGet("https://api.weixin.qq.com/sns/jscode2session", params, handler);
		JSONObject json = (JSONObject) obj;
		return json;
	}

	public void execute(Map<String, Object> paramMap, HandlerChain paramHandlerChain, SysHead sysHead, AppHead appHead,
			JSONObject data) {

	}

}
