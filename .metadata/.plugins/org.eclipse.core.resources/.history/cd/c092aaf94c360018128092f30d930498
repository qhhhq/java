package net.qhhhq.service.http.qcloud;

import java.io.IOException;
import java.net.URISyntaxException;
import java.util.HashMap;
import java.util.Map;

import org.apache.commons.codec.binary.Base64;
import org.apache.log4j.Logger;
import org.json.JSONObject;

import com.qcloud.weapp.authorization.Constants;

import io.netty.handler.codec.http.HttpHeaders;
import net.qhhhq.http.HttpClient;
import net.qhhhq.http.JsonResponseHandler;
import net.qhhhq.service.common.HandlerChain;
import net.qhhhq.service.common.HttpRequestHandler;
import net.qhhhq.utils.AES;

public class LoginService implements HttpRequestHandler {

	private static Logger log = Logger.getLogger(LoginService.class);

	public void handle(Map<String, Object> paramMap, HandlerChain paramHandlerChain, JSONObject data) {
		log.info(paramMap.get("uri"));
		if(paramMap.get("uri") != null && paramMap.get("uri").equals("/login")) {		//登录
			HttpHeaders headers = (HttpHeaders) paramMap.get("headers");
			String code = headers.get(Constants.WX_HEADER_CODE);
			String encryptedData = headers.get(Constants.WX_HEADER_ENCRYPTED_DATA);
			String iv = headers.get(Constants.WX_HEADER_IV);
			JSONObject json = getOpenId(code);
			byte[] resultByte  = AES.decrypt(Base64.decodeBase64(encryptedData),
                    Base64.decodeBase64(json.getString("")),
                    Base64.decodeBase64(iv));
                if(null != resultByte && resultByte.length > 0){
                    String userInfo = new String(resultByte, "UTF-8");
                    log.info(userInfo);
                }
		}

	}


	/**
	 * 获取openid和session_key
	 * @param code
	 * @return
	 * @throws URISyntaxException
	 * @throws IOException
	 */
	private JSONObject getOpenId(String code){
		Map<String, String> params = new HashMap<String, String>();
		params.put("appid", "wx275a30f644ebc4c9");
		params.put("secret", "ae0c581b7a6bf0792c87d00a1a8a1d9b");
		params.put("js_code", code);
		params.put("grant_type", "authorization_code");
		JsonResponseHandler handler = new JsonResponseHandler();
		Object obj;
		try {
			obj = HttpClient.doGet("https://api.weixin.qq.com/sns/jscode2session", params, handler);
		} catch (URISyntaxException e) {
			e.printStackTrace();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		JSONObject json = (JSONObject) obj;
		return json;
	}

}
